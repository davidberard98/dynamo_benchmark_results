<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <style>
      .bordered_table {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 3px;
      }
    </style>
    <script>
      const BASE_URL = "https://raw.githubusercontent.com/davidberard98/dynamo_benchmark_results/master/";
      const LOOKUP_URL = BASE_URL + "lookup.csv";
      const METRIC = "performance";
      const SUPPORTED_DTYPE = ["amp", "float32"];

      const DIV_DAY1 = "div_day1";
      const DIV_DAY2 = "div_day2";
      const DAY1_DEFAULT_SELECTION = "Select control day";
      const DAY2_DEFAULT_SELECTION = "Select test day";
      const DAY1_DROPDOWN_ID = "dropdown_day1";
      const DAY2_DROPDOWN_ID = "dropdown_day2";

      const DTYPE_DIV = "div_dtype";
      const DTYPE_DEFAULT_SELECTION = "Select dtype";
      const DTYPE_DROPDOWN_ID = "dropdown_dtype";

      // showDateSelectionDropdown loads this and then stashes it here.
      lookup_csv_global = null;

      function naiveParseCsv(msg, delimiter=",", expected_cols=null) {
        let as_array = msg.split("\n").map(x => x.split(delimiter));
        if (expected_cols !== null) {
          as_array = as_array.filter(subarray => subarray.length == expected_cols);
        }
        return as_array;
      }

      function parseLookupCsv(msg) {
        data = naiveParseCsv(msg, ",", 4);
        data = data.map(row => ({
          "day": row[0],
          "metric": row[1],
          "dtype": row[2],
          "path": row[3],
        })).filter(
          row => row["metric"] == METRIC && SUPPORTED_DTYPE.includes(row["dtype"])
        );
        return data;
      }

      function areDaysSelected() {
        const id1 = document.getElementById(DAY1_DROPDOWN_ID).selectedIndex;
        const id2 = document.getElementById(DAY2_DROPDOWN_ID).selectedIndex;
        return (id1 > 0 && id2 > 0);
      }

      function showComparisonTable() {
        console.log("TODO implement table comparison");
      }

      function showDtypeSelectionDropdown() {
        if (lookup_csv_global === null) {
          console.error("lookup_csv_global is null");
        }
        if (!areDaysSelected()) {
          return;
        }
        const day1 = document.getElementById(DAY1_DROPDOWN_ID).selectedOptions[0].text;
        const day2 = document.getElementById(DAY2_DROPDOWN_ID).selectedOptions[0].text;

        let parent = document.getElementById(DTYPE_DIV);

        let select = document.createElement("select");
        let default_option = document.createElement("option");
        default_option.text = DTYPE_DEFAULT_SELECTION;
        select.add(default_option);

        // get common dtype options from
        const day1_dtypes = lookup_csv_global
                            .filter(row => row["day"] == day1)
                            .map(row => row["dtype"]);
        const day2_dtypes = lookup_csv_global
                            .filter(row => row["day"] == day2)
                            .map(row => row["dtype"]);

        const available_dtypes = day1_dtypes.filter(dtype => day2_dtypes.includes(dtype));
        console.log(day1_dtypes, day2_dtypes, available_dtypes);

        for (const dtype of available_dtypes) {
          console.log(dtype);
          let dtype_option = document.createElement("option");
          dtype_option.text = dtype;
          select.add(dtype_option);
        }

        select.id = DTYPE_DROPDOWN_ID;
        select.onchange = showComparisonTable;
        parent.appendChild(select);
      }

      function showDateSelectionDropdowns() {
        fetch(LOOKUP_URL)
          .then(async function(response) {
            const text = await response.text();
            let data = parseLookupCsv(text);

            // stash the csv data globally for later use
            lookup_csv_global = data;

            let unique_days = [...new Set(data.map(x => x["day"]))].reverse();
            console.log(data);
            console.log(unique_days);
            const create_dropdown = function(parent_id, dropdown_id, default_text) {
              let parent = document.getElementById(parent_id);

              let select = document.createElement("select");
              let default_option = document.createElement("option");
              default_option.text = default_text;
              select.add(default_option);
              for (const day of unique_days) {
                let option = document.createElement("option");
                option.text = day;
                select.add(option);
              }
              select.id = dropdown_id;

              select.onchange = showDtypeSelectionDropdown;

              parent.appendChild(select);
            };

            create_dropdown(DIV_DAY1, DAY1_DROPDOWN_ID, DAY1_DEFAULT_SELECTION);
            create_dropdown(DIV_DAY2, DAY2_DROPDOWN_ID, DAY2_DEFAULT_SELECTION);
          })
      }

      function run() {
        showDateSelectionDropdowns();
      }

      /*
      async function(response) {
              const text = await response.text();
              as_csv = parseCsv(text);
              let min_speedup = Math.min(...as_csv.slice(1).map(subarr => subarr[3]));
              console.log(as_csv.slice(1).map(subarr => subarr[3]))
              min_speedup = Math.min(min_speedup, 0.0)
              let max_speedup = Math.max(...as_csv.slice(1).map(subarr => subarr[3]));
              max_speedup = Math.max(max_speedup, 0.0)
              console.log("!! ", min_speedup, max_speedup)
              const dataElement = document.getElementById("data");
              dataElement.innerHTML = "";
              const tableElement = document.createElement("table");
              tableElement.classList.add("bordered_table");
              dataElement.appendChild(tableElement);
              for (let i=0; i<as_csv.length; ++i) {
                const row = as_csv[i];
                const tr = document.createElement("tr");
                tr.classList.add("bordered_table");
                tableElement.appendChild(tr);
                for (let j=0; j < row.length; ++j) {
                  let td_type = (i == 0 ? "th" : "td");
                  const td = document.createElement(td_type);
                  td.classList.add("bordered_table");
                  tr.appendChild(td);
                  let text = row[j].toString();
                  if (j == 3 && typeof row[j] === 'number') {
                    text = (row[j] * 100).toFixed(2) + "%";
                  }
                  td.appendChild(document.createTextNode(text));
                  if (j == 3 && typeof row[3] === 'number') {
                    if (row[3] > 0) {
                      const ratio = row[3] / max_speedup;
                      const otherColor = parseInt(255 * (1 - ratio)).toString();
                      td.style.backgroundColor = "rgb(" + otherColor + ", 255, " + otherColor + ")";
                      console.log(td.style.backgroundColor);
                    } else if (row[3] < 0) {
                      const ratio = row[3] / min_speedup;
                      const otherColor = parseInt(255 * (1 - ratio)).toString();
                      td.style.backgroundColor = "rgb(255, " + otherColor + ", " + otherColor + ")";
                      console.log(td.style.backgroundColor);
                    }
                  }
                }
              }
            });
      */

      window.onload = run;
    </script>
  </head>
  <body>
    <h1>Torchbench metric diff tool</h1>
    <div style="width: 500px;">
      <div style="width:240px; float: left" id="div_day1"></div>
      <div style="width:240px; float: right" id="div_day2"></div>
    </div>
    <br />
    <div id="div_dtype"></div>
    <br />
    <div id="div_table"></div>
  </body>
</html>
